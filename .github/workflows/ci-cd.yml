name: CI/CD Pipeline DevOps

on:
  # Ejecuta la CI/CD en cualquier push a 'develop' o 'main'
  push:
    branches:
      - main
      - develop
  # También en Pull Requests a 'main' o 'develop'
  pull_request:
    branches:
      - main
      - develop

env:
  # Nombre base para las imágenes en Docker Hub (Reemplaza con tu usuario)
  DOCKER_IMAGE_BASE: espisano/ifts29_tpi_devops
  # Tag único para la imagen (usamos los primeros 7 caracteres del SHA del commit)
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # =================================================================
  # JOB 1: INTEGRACIÓN CONTINUA (Build y Test)
  # =================================================================
  ci:
    name: Build & Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # --- BACKEND TESTS  ---
      - name: Install Backend Dependencies
        run: cd backend && npm install

      - name: Run Backend Tests
        run: cd backend && npm test # Correr tests del backend 
        
      # --- FRONTEND TESTS  ---
      - name: Install Frontend Dependencies
        run: cd frontend && npm install

      - name: Run Frontend Tests
        run: cd frontend && npm test # Correr tests del frontend 

  # =================================================================
  # JOB 2: CONTAINERIZACIÓN (Build y Push de Imágenes)
  # =================================================================
  docker_push:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    needs: ci # Solo se ejecuta si el job 'ci' pasa exitosamente
    if: success() # Asegura que solo se ejecute si la CI fue exitosa
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- Login en Docker Hub ---
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # --- Build y Push del Backend ---
      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend # Ruta al Dockerfile del backend 
          push: true
          tags: ${{ env.DOCKER_IMAGE_BASE }}-backend:${{ env.IMAGE_TAG }}
          
      # --- Build y Push del Frontend ---
      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend # Ruta al Dockerfile del frontend 
          push: true
          tags: ${{ env.DOCKER_IMAGE_BASE }}-frontend:${{ env.IMAGE_TAG }}

  # =================================================================
  # JOB 3: DESPLIEGUE CONTINUO (Solo en la rama 'main')
  # =================================================================
  deploy:
    name: Automatic Deployment
    runs-on: ubuntu-latest
    needs: docker_push # Solo se ejecuta si las imágenes se subieron correctamente
    # Esta es la lógica de CD: solo despliega si es un push a la rama 'main'
    if: github.ref == 'refs/heads/main' && success()

    steps:
      - name: Deploy to Environment (Simulación)
        run: |
          echo "Despliegue automático iniciado para la rama main..."
          # EJEMPLO 1: Despliegue en Heroku (usando la imagen de Docker Hub)
          # Requeriría una acción específica o un script de CLI de Heroku aquí.
          echo "Simulando despliegue de ${{ env.DOCKER_IMAGE_BASE }}-backend:${{ env.IMAGE_TAG }} en Heroku/Render/EC2..." [cite: 24]

          # EJEMPLO 2 (Si usas EC2/SSH):
          # - name: Deploy to EC2 via SSH
          #   uses: appleboy/ssh-action@v1.0.3
          #   with:
          #     host: ${{ secrets.EC2_HOST }}
          #     username: ${{ secrets.EC2_USERNAME }}
          #     key: ${{ secrets.EC2_SSH_KEY }}
          #     script: |
          #       docker pull ${{ env.DOCKER_IMAGE_BASE }}-backend:${{ env.IMAGE_TAG }}
          #       docker-compose -f /path/to/remote/docker-compose.yml up -d
